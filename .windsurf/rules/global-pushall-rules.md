---
trigger: always_on
---

# ===========================================
# Project: PushAll (SaasyKit + Laravel 12 + FilamentPHP)
# ===========================================

description: |
  PushAll is a SaaS built on top of SaasyKit (Laravel 12 + Vite + FilamentPHP).
  It allows creating and managing passes for Apple Wallet (.pkpass) and Google Wallet (JWT),
  and sending "push notifications" via pass updates (APNs / Google Wallet).
  The admin panel is built entirely with FilamentPHP; the API is exposed via Laravel (Sanctum).

docs:
  saasykit: "https://saasykit.com/docs/"
  filament: "https://filamentphp.com/docs"
  laravel: "https://laravel.com/docs"
  google_wallet: "https://developers.google.com/wallet"
  apple_wallet_passkit: "https://developer.apple.com/documentation/walletpasses"

stack:
  base: SaasyKit (Laravel 12, Vite, FilamentPHP)
  admin: FilamentPHP (Panels, Resources, Pages, Widgets)
  api: Laravel (Sanctum, Form Requests, Services)
  db: MySQL/MariaDB
  wallet:
    apple: PassKit (certificates .p12/.pem, APNs HTTP/2)
    google: Google Wallet API (JWT with Service Account)
  queues: Laravel Queues (database/redis)
  assets: Vite

env_vars:
  - APP_URL
  - APP_ENV
  - APP_KEY
  - SANCTUM_STATEFUL_DOMAINS
  - APPLE_PASS_CERT_PATH
  - APPLE_PASS_KEY_PATH
  - APPLE_PASS_PASSWORD
  - APPLE_TEAM_ID
  - APPLE_PASS_TYPE_ID            # e.g.: pass.com.pushall.generic
  - APPLE_WEB_SERVICE_URL         # Public URL for PassKit web service
  - APPLE_WEB_SERVICE_AUTH        # Simple token/header for PassKit endpoints
  - GOOGLE_WALLET_CREDENTIALS     # Path to Service Account JSON
  - GOOGLE_WALLET_ISSUER_ID
  - GOOGLE_WALLET_ORIGINS         # Allowed origins for "Add to Google Wallet"

# Note: respect SaasyKit's existing structure.
# If paths differ, prioritize the ones generated by Filament commands and SaasyKit defaults.

folders_hint:
  backend:
    - app/Models
    - app/Http/Controllers/API
    - app/Http/Requests
    - app/Services/Wallet
    - app/Jobs
    - database/migrations
    - storage/app/passes
  admin:
    - app/Filament      # Filament generates all admin files here
  config:
    - certs/ (keys and certificates; never commit to repo)
    - .env

db_models:
  WalletPass:
    columns:
      - id (uuid)
      - user_id
      - platform: enum[apple, google]
      - type: enum[generic, loyalty, offer, event]
      - serial_number (Apple, unique)
      - class_id (Google)          # {issuerId}.{classId}
      - object_id (Google)         # {issuerId}.{objectId}
      - device_library_identifier (Apple, nullable)
      - push_token (Apple, nullable)
      - status: enum[draft, active, revoked, expired]
      - meta: json
      - timestamps
    notes:
      - Adapt to multi-tenancy only if the chosen SaasyKit setup requires it.

conventions:
  backend:
    - Use Services for Wallet logic (Apple/Google). Keep controllers thin.
    - Validate with Form Requests. API responses must be consistent: {data, meta, errors}.
    - Update/notification operations â†’ queued Jobs with retries.
    - Certificates/keys only from .env or secure storage, never in repo.
  admin_filament:
    - ALWAYS generate Resources/Pages/Widgets/Models using Filament Artisan commands.
    - Never manually create admin files outside Filament/SaasyKit workflow.
    - Table Actions for "Update Pass" and "Revoke".
    - Dashboard Widgets for metrics (active passes, installs, sends).
  api:
    - Prefix `/api`, secured with Sanctum (except PassKit-required endpoints for Apple).
  security:
    - HTTPS required.
    - Log and audit external calls (APNs / Google Wallet).
    - For PassKit web service, implement auth token and follow the official spec.

flows:
  create_pass:
    - Admin (Filament) creates pass via a Resource form.
    - Service:
      - Apple: build pass.json + assets, sign, and package into .pkpass.
      - Google: create class/object via API or JWT for "Add to Google Wallet".
    - Save serial/object IDs and set status=active. Display "Add to Wallet" buttons.
  register_device_apple:
    - iOS calls web service: /v1/devices/{deviceLibraryIdentifier}/registrations/{passTypeId}/{serialNumber}
    - Store deviceLibraryIdentifier and pushToken.
  update_pass:
    - Admin runs "Update" action.
    - Apple: regenerate pass if fields change and push update via APNs.
    - Google: PATCH the object; Google sends user notification.

endpoints_spec_hint:
  apple_passkit_web_service:
    base: /wallet/apple
    routes:
      - GET  /v1/devices/{deviceLibraryIdentifier}/registrations/{passTypeId}
      - POST /v1/devices/{deviceLibraryIdentifier}/registrations/{passTypeId}/{serial}
      - GET  /v1/passes/{passTypeId}/{serial}
      - POST /v1/log
    notes:
      - Auth via header/token; follow PassKit spec.
      - pushToken and deviceLibraryIdentifier can rotate; update accordingly.

instructions_for_ai:
  - Respect SaasyKit's structure and conventions. If conflicts occur, follow its official docs.
  - For Filament, ALWAYS use Artisan commands to generate:
      * Model:             php artisan make:model WalletPass -m
      * Resource:          php artisan make:filament-resource WalletPass
      * Page (custom):     php artisan make:filament-page UpdatePass
      * Widget (stats):    php artisan make:filament-widget PassStats --stats-overview
      * Relation Manager:  php artisan make:filament-relation-manager ...
    (Docs: {{docs.filament}})
  - Create Services `ApplePassService` and `GooglePassService` with methods: create(), update(), notify().
  - Apple:
      * Include webServiceURL and authenticationToken in the pass.
      * Sign .pkpass with Pass Type ID certificate; store in storage/app/passes.
      * Push updates via APNs HTTP/2.
      * Follow PassKit web service spec for registration/download/update.
  - Google:
      * Generate JWT "Add to Google Wallet" with valid classes/objects and allowed `origins`.
      * For updates, use REST v1 (patch) depending on object type.
  - Tests:
      * Basic tests for web service endpoints and Services (mock external calls).
  - Jobs:
      * Queue notifications/updates; configure backoff and retries.

next_steps:
  - Generate `WalletPass` (model + migration) with Artisan.
  - Scaffold `WalletPassResource` in Filament (forms, tables, actions).
  - Implement `ApplePassService` (.pkpass signing + APNs) and PassKit endpoints.
  - Implement `GooglePassService` (JWT + REST updates) and "Add to Google Wallet" link.
  - Add Jobs for notifications (ApplePushJob, GoogleUpdateJob).
  - Configure queue (database/redis) and supervisor.
  - Add dashboard metrics widgets in Filament.

acceptance_criteria:
  - Able to create a pass from Filament and get:
      * Downloadable .pkpass (Apple) with webServiceURL+auth.
      * "Add to Google Wallet" link (valid JWT; correct `origins`).
  - iOS device registers and receives update notification.
  - Android shows notification when object updates.
  - Logs and retry mechanism for failed notifications.
